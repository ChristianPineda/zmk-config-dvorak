# Actualización: agrega job de diagnóstico que se ejecuta si el job de build falla.
name: Build ZMK firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  validate-keymaps:
    name: Validate keymap files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make diagnostic script executable
        run: |
          mkdir -p .github/scripts
          cat > .github/scripts/inspect_keymap.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          FAIL=0
          printf "Searching for keymap files in config/ ...\n"
          FILES=$(find config -type f -name '*.keymap' || true)
          if [[ -z "$FILES" ]]; then
            printf "No config/*.keymap files found. Skipping validation.\n"
            exit 0
          fi
          for F in $FILES; do
            printf "\n==> Inspecting: %s\n" "$F"
            file -bi "$F" || true
            printf "First 12 lines (visible ends):\n"
            sed -n '1,12p' "$F" | nl -ba -w3 -s': ' | sed -n '1,12p'
            printf "\nChecking BOM (UTF-8 BOM = EF BB BF): "
            head -c3 "$F" | xxd -p -c3 || true
            printf "\nSearching for non-ASCII bytes:\n"
            if grep -nP "[^\x00-\x7F]" "$F" >/dev/null 2>&1; then
              printf "  NON-ASCII bytes found in lines:\n"
              grep -nP "[^\x00-\x7F]" "$F" || true
              FAIL=1
            else
              printf "  none\n"
            fi
            printf "\nSearching for CRLF line endings:\n"
            if grep -n $'\r' "$F" >/dev/null 2>&1; then
              printf "  CR (\\r) bytes found (CRLF). Lines:\n"
              grep -n $'\r' "$F" || true
              FAIL=1
            else
              printf "  none\n"
            fi
            printf "\nSearching for BOMs explicitly (hex EFBBBF):\n"
            if head -c3 "$F" | grep -q $'\xEF\xBB\xBF'; then
              printf "  BOM detected\n"
              FAIL=1
            else
              printf "  none\n"
            fi
            printf "\nSearching for '//' or '/*' comment tokens (these break devicetree inside bindings):\n"
            if grep -n "//" "$F" >/dev/null 2>&1 || grep -n "/\\*" "$F" >/dev/null 2>&1; then
              printf "  Comment tokens found, printing occurrences with context:\n"
              grep -n -C2 -E "//|/\\*" "$F" || true
              grep -n -E "//|/\\*" "$F" | cut -d: -f1 | sort -u | while read -r LN; do
                printf "\n--- Context around line %s ---\n" "$LN"
                sed -n "$((LN-3)),$((LN+3))p" "$F" | nl -ba -w3 -s': '
                printf "\nHex of exact line %s:\n" "$LN"
                sed -n "${LN}p" "$F" | xxd -g 1 -u
                sed -n "${LN}p" "$F" | cat -A -v
              done
              FAIL=1
            else
              printf "  none\n"
            fi
            printf "\nSearching for control characters (except TAB and LF):\n"
            if LC_ALL=C grep -n '[^[:print:]\t\n]' "$F" >/dev/null 2>&1; then
              printf "  Control characters found in lines:\n"
              LC_ALL=C grep -n '[^[:print:]\t\n]' "$F" || true
              FAIL=1
            else
              printf "  none\n"
            fi

            printf "\nShow full file with line numbers (for reference):\n"
            nl -ba -w3 -s': ' "$F" | sed -n '1,300p'
          done

          if [[ "$FAIL" -ne 0 ]]; then
            printf "\nValidation failed: one or more keymap issues detected. Fix them and push again.\n"
            exit 2
          fi
          printf "\nAll keymap checks passed.\n"
          EOF
          chmod +x .github/scripts/inspect_keymap.sh

      - name: Run keymap inspection
        run: ./.github/scripts/inspect_keymap.sh

  build:
    name: Build (reusable ZMK workflow)
    needs: validate-keymaps
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@v0.3

  diagnose:
    name: Diagnose keymap on build failure
    needs: build
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add diagnose script
        run: |
          mkdir -p .github/scripts
          cat > .github/scripts/diagnose_failed_build.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          printf "Running diagnose for keymap files (lines + hex around typical failure area)\n"
          FILES=$(find config -type f -name '*.keymap' || true)
          if [[ -z "$FILES" ]]; then
            printf "No keymap files found under config/\n"
            exit 0
          fi
          for F in $FILES; do
            printf "\n==> FILE: %s\n" "$F"
            printf "file -bi: "
            file -bi "$F" || true
            printf "\n--- Lines 1..120 (with numbers) ---\n"
            nl -ba -w3 -s': ' "$F" | sed -n '1,120p'
            printf "\n--- Lines 28..36 (context around reported failure) ---\n"
            nl -ba -w3 -s': ' "$F" | sed -n '28,36p'
            printf "\n--- Hex/bytes of lines 28..36 ---\n"
            sed -n '28,36p' "$F" | nl -ba -w3 -s': ' | while read -r L; do
              LN=$(printf "%s" "$L" | cut -d: -f1)
              LINE_CONTENT=$(sed -n "${LN}p" "$F" || true)
              printf "\nLine %s text: %s\n" "$LN" "$LINE_CONTENT"
              printf "Line %s as hex:\n" "$LN"
              sed -n "${LN}p" "$F" | xxd -g 1 -u || true
              printf "Line %s visible chars (cat -A):\n" "$LN"
              sed -n "${LN}p" "$F" | cat -A -v || true
            done
          done
          EOF
          chmod +x .github/scripts/diagnose_failed_build.sh

      - name: Run diagnose script
        run: ./.github/scripts/diagnose_failed_build.sh
